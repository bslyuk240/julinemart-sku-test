<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vendor Portal - JulineMart</title>
  <style>
    :root {
      --purple-dark: #2d1b69;
      --purple: #5b21b6;
      --purple-light: #7c3aed;
      --orange: #f97316;
      --orange-hover: #ea580c;
      --bg: #fafafa;
      --card: #ffffff;
      --text: #1f2937;
      --text-light: #6b7280;
      --border: #e5e7eb;
      --success: #10b981;
      --danger: #ef4444;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); }
    header { background: linear-gradient(135deg, var(--orange) 0%, var(--orange-hover) 100%); color: white; padding: 16px 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
    .header-content { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .vendor-badge { background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; }
    .logout-btn { padding: 8px 20px; background: rgba(255,255,255,0.2); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 500; transition: all 0.2s; }
    .logout-btn:hover { background: rgba(255,255,255,0.3); }
    .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
    .dashboard-header { margin-bottom: 32px; }
    .dashboard-header h1 { font-size: 32px; color: var(--text); margin-bottom: 8px; }
    .dashboard-header p { color: var(--text-light); font-size: 16px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .stat-card { background: white; padding: 24px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .stat-label { color: var(--text-light); font-size: 14px; margin-bottom: 8px; }
    .stat-value { font-size: 32px; font-weight: 700; color: var(--text); }
    .stat-card.success .stat-value { color: var(--success); }
    .stat-card.warning .stat-value { color: var(--orange); }
    .card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid var(--border); margin-bottom: 24px; }
    .card-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; color: var(--text); }
    .search-bar input { width: 100%; max-width: 400px; padding: 12px 16px; border: 1px solid var(--border); border-radius: 10px; font-size: 14px; margin-bottom: 20px; }
    .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th { background: #f9fafb; padding: 12px 16px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border); }
    td { padding: 16px; border-bottom: 1px solid var(--border); }
    tr:hover td { background: #f9fafb; }
    .sku-cell { font-family: 'Courier New', monospace; font-weight: 600; color: var(--orange); }
    .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    .status-badge.in-stock { background: #d1fae5; color: #065f46; }
    .status-badge.low-stock { background: #fef3c7; color: #92400e; }
    .status-badge.out-of-stock { background: #fee2e2; color: #991b1b; }
    .btn { padding: 8px 16px; border-radius: 8px; border: none; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: var(--orange); color: white; }
    .btn-primary:hover { background: var(--orange-hover); }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-light); }
    .error-banner { background: #fee2e2; color: #991b1b; padding: 12px 16px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #fecaca; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7"></script>
  <script src="../js/shared/supabase.js"></script>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="header-left">
        <h1>üè™ Vendor Portal</h1>
        <div class="vendor-badge" id="vendorBadge">Loading...</div>
      </div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="container">
    <div class="dashboard-header">
      <h1>Stock Management</h1>
      <p>Update your product inventory in real-time</p>
    </div>

    <div id="errorBanner" class="error-banner" style="display: none;"></div>

    <div class="stats-grid">
      <div class="stat-card"><div class="stat-label">Total Products</div><div class="stat-value" id="totalProducts">0</div></div>
      <div class="stat-card success"><div class="stat-label">In Stock</div><div class="stat-value" id="inStock">0</div></div>
      <div class="stat-card warning"><div class="stat-label">Low Stock (‚â§5)</div><div class="stat-value" id="lowStock">0</div></div>
      <div class="stat-card"><div class="stat-label">Out of Stock</div><div class="stat-value" id="outOfStock">0</div></div>
    </div>

    <div class="card">
      <h2 class="card-title">Your Products</h2>
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="üîç Search by SKU or product name..." onkeyup="filterProducts()" />
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>SKU</th>
              <th>Product Name</th>
              <th>Category</th>
              <th>Stock Qty</th>
              <th>Status</th>
              <th>In Stock?</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="productsTable">
            <tr><td colspan="7"><div class="empty-state">üì¶ Loading your products...</div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = window.SUPABASE_URL;
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY;
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let vendorCode = localStorage.getItem('vendor_code');
    let vendorName = localStorage.getItem('vendor_name');
    let allProducts = [];

    function logout() {
      localStorage.clear();
      window.location.href = '../index.html';
    }

    function showError(message) {
      const banner = document.getElementById('errorBanner');
      banner.textContent = message;
      banner.style.display = 'block';
    }

    function hideError() {
      document.getElementById('errorBanner').style.display = 'none';
    }

    function getStatusBadge(qty, inStock) {
      if (!inStock || qty === 0) return '<span class="status-badge out-of-stock">Out of Stock</span>';
      if (qty <= 5) return '<span class="status-badge low-stock">Low Stock</span>';
      return '<span class="status-badge in-stock">In Stock</span>';
    }

    async function loadProducts() {
      if (!vendorCode) {
        showError('Vendor not logged in. Redirecting...');
        setTimeout(() => window.location.href = '../index.html', 2000);
        return;
      }
      
      document.getElementById('vendorBadge').textContent = `${vendorCode} - ${vendorName}`;
      hideError();

      try {
        console.log('Fetching SKUs for vendor:', vendorCode);
        
        // Fetch SKUs for this vendor using anon key (RLS policies allow this)
        const { data: skus, error: skuError } = await sb
          .from('skus')
          .select('*')
          .eq('vendor_code', vendorCode)
          .order('sku', { ascending: true });

        if (skuError) {
          console.error('SKU fetch error:', skuError);
          throw new Error(`Failed to load products: ${skuError.message}`);
        }

        console.log('Found SKUs:', skus?.length || 0);

        if (!skus || skus.length === 0) {
          document.getElementById('productsTable').innerHTML = 
            `<tr><td colspan="7"><div class="empty-state">No products found for ${vendorCode}</div></td></tr>`;
          return;
        }

        const skuList = skus.map(s => s.sku);
        
        // Fetch inventory data
        console.log('Fetching inventory for', skuList.length, 'products');
        const { data: inventory, error: invError } = await sb
          .from('inventory')
          .select('*')
          .in('sku', skuList);

        if (invError) {
          console.warn('Inventory fetch warning:', invError);
        }

        console.log('Found inventory records:', inventory?.length || 0);

        // Merge SKU and inventory data
        allProducts = skus.map(sku => {
          const inv = inventory?.find(i => i.sku === sku.sku);
          return {
            ...sku,
            stock_quantity: inv?.stock_quantity || 0,
            in_stock: inv?.in_stock !== undefined ? inv.in_stock : true
          };
        });

        renderProducts(allProducts);
        updateStats();

      } catch (err) {
        console.error('Error loading products:', err);
        showError(`Error: ${err.message}. Please refresh the page or contact support.`);
        document.getElementById('productsTable').innerHTML = 
          `<tr><td colspan="7"><div class="empty-state">‚ö†Ô∏è Error loading products</div></td></tr>`;
      }
    }

    function renderProducts(products) {
      const tbody = document.getElementById('productsTable');
      if (!products || products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state">No products to display</div></td></tr>';
        return;
      }
      
      tbody.innerHTML = products.map(p => `
        <tr>
          <td class="sku-cell">${p.sku}</td>
          <td>${p.product_name || '-'}</td>
          <td>${p.category_code || '-'}</td>
          <td>
            <input 
              type="number" 
              min="0" 
              max="9999" 
              value="${p.stock_quantity}" 
              onchange="updateProductStock('${p.sku}', this.value)"
              style="width: 80px; padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px;"
            />
          </td>
          <td>${getStatusBadge(p.stock_quantity, p.in_stock)}</td>
          <td>
            <input 
              type="checkbox" 
              ${p.in_stock ? 'checked' : ''} 
              onchange="updateProductInStock('${p.sku}', this.checked)"
              style="transform: scale(1.2); cursor: pointer;"
            />
          </td>
          <td><button class="btn btn-primary" onclick="saveChanges('${p.sku}')">Save</button></td>
        </tr>
      `).join('');
    }

    function updateStats() {
      const total = allProducts.length;
      const inStock = allProducts.filter(p => p.in_stock && p.stock_quantity > 0).length;
      const lowStock = allProducts.filter(p => p.in_stock && p.stock_quantity > 0 && p.stock_quantity <= 5).length;
      const outOfStock = allProducts.filter(p => !p.in_stock || p.stock_quantity === 0).length;
      
      document.getElementById('totalProducts').textContent = total;
      document.getElementById('inStock').textContent = inStock;
      document.getElementById('lowStock').textContent = lowStock;
      document.getElementById('outOfStock').textContent = outOfStock;
    }

    function updateProductStock(sku, newQuantity) {
      const product = allProducts.find(p => p.sku === sku);
      if (product) {
        product.stock_quantity = parseInt(newQuantity) || 0;
        renderProducts(allProducts);
        updateStats();
      }
    }

    function updateProductInStock(sku, inStock) {
      const product = allProducts.find(p => p.sku === sku);
      if (product) {
        product.in_stock = inStock;
        renderProducts(allProducts);
        updateStats();
      }
    }

    function filterProducts() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const filtered = allProducts.filter(p => 
        p.sku.toLowerCase().includes(search) || 
        (p.product_name && p.product_name.toLowerCase().includes(search))
      );
      renderProducts(filtered);
    }

    async function saveChanges(sku) {
      const product = allProducts.find(p => p.sku === sku);
      if (!product) return;
      
      const saveBtn = event.target;
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
      
      try {
        // Use anon key with RLS policies
        const { error } = await sb
          .from('inventory')
          .upsert({
            sku: product.sku,
            stock_quantity: product.stock_quantity,
            in_stock: product.in_stock,
            updated_by: vendorCode,
            last_updated: new Date().toISOString(),
            vendor_code: vendorCode
          }, {
            onConflict: 'sku'
          });
        
        if (error) {
          console.error('Save error:', error);
          throw new Error(error.message);
        }
        
        // Show success feedback
        saveBtn.textContent = '‚úì Saved';
        saveBtn.style.background = '#10b981';
        
        setTimeout(() => {
          saveBtn.textContent = 'Save';
          saveBtn.style.background = '';
          saveBtn.disabled = false;
        }, 2000);
        
      } catch (e) {
        console.error('Save error:', e);
        alert(`‚ùå Error saving changes for ${sku}: ${e.message}`);
        saveBtn.textContent = 'Save';
        saveBtn.disabled = false;
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', loadProducts);
  </script>
</body>
</html>
